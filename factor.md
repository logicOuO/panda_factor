{=== 1. 动量 MOM ===}
M20:=C/REF(C,20)-1;

M5:=C/REF(C,5)-1;
M1:=C/REF(C,1)-1;
MA20:=MA(C,20);
STD20:=STD(C,20);
MOM_Q:=SIGN(C-MA20)*POW(C-MA20,2)/(STD20*STD20+0.0001);

{=== 2. 资金流 FLOW ===}
AMT:=AMOUNT;
MCAP:=FINANCE(1)*C;
FLOW_MV1:=AMT/(MCAP+0.0001);
FLOW_MV:=MIN(MAX(FLOW_MV1,0.01),100);

{=== 3. 波动 VOL ===}
TR1:=MAX(MAX(H-L,ABS(H-REF(C,1))),ABS(L-REF(C,1)));
ATR14:=MA(TR1,14);
ATR10:=MA(TR1,10);
ATR20_H:=HHV(ATR10,20);
VOL_C:=1-ATR10/(ATR20_H+0.0001);
VOL_HL:=(H-L)/C;

{=== 4. 盘口代理 BOOK ===}
CPR:=(C-L)/(H-L+0.0001);
BODY:=ABS(C-O)/(H-L+0.0001);
US1:=(H-MAX(O,C))/(H-L+0.0001);
GAP_M:=O-(REF(H,1)+REF(L,1))/2;

{=== 5. 主力行为 MAIN ===}
MED_A:=MA(AMOUNT,20);
MED_R:=MA((H/L-1),20);
SQZ:=(AMOUNT>2*MED_A) AND ((H/L-1)<2*MED_R);
VW5:=SUM(C*AMOUNT,5)/SUM(AMOUNT,5);
MAIN_V:=C>VW5*1.02;
CHP:=AMOUNT/(FINANCE(1)+0.0001);

{=== 6. 尾部风险 TAIL ===}
RET:=LN(C/REF(C,1));
TAIL_MD:=LLV(RET,20);
TAIL_SK:=STD(RET,20);
TAIL_V1:=EMA(RET,10);
TAIL_V:=LLV(TAIL_V1,40);
TAIL_J:=ABS(RET)>HHV(ABS(RET),250)*0.95;

{=== 7. 非流动性 ILLIQ ===}
ILLIQ_A:=ABS(RET)/(AMT/(FINANCE(1)*C)+0.0001);
ILLIQ_T:=1/(VOL/CAPITAL+0.0001);
ILLIQ_Z:=MA(RET=0,10);
ILLIQ_R:=(H-L)/(AMT+0.0001)*1000000;

{=== 8. 协整 COINT ===}
IDX1:="999999$CLOSE";
BETA_V:=SLOPE(C,20);
RES1:=IDX1-BETA_V*C;
RES_Z1:=(RES1-MA(RES1,20))/STD(RES1,20);

{=== 9. 偏度 SKEW ===}
SKEW_R:=MA(POW((RET-MA(RET,20))/STD(RET,20),3),20);
SKEW_C:=EMA(POW(RET-MA(RET,20),3),20)/(POW(STD(RET,20),3)+0.0001);
SKEW_T:=MA(POW((C-O)/O-MA((C-O)/O,20),3),20);
SKEW_H:=MA(POW(H/L-MA(H/L,20),3),20);

{=== 10. 支撑阻力 SR ===}
SR_B:=C>HHV(H,20);
SR_G:=(O-REF(C,1))/REF(C,1);
SR_P:=(C-LLV(L,10))/(HHV(H,10)-LLV(L,10)+0.0001);
SR_PS:=MA(C>O,12);

{=== 11. 缺口 GAP ===}
GAP_I:=((REF(H,1)>L) AND (REF(L,1)<H))=0;
GAP_S:=(O-REF(C,1))/REF(C,1);
GAP_F:=(C-O)/(O-REF(C,1)+0.0001);
GAP_FO:=(O/REF(C,1)-1);

{=== 12. 量价背离 VPD ===}
VPD_Z1:=(RET-MA(RET,20))/STD(RET,20) - (AMT-MA(AMT,20))/STD(AMT,20);
VPD_O:=SIGN(OBV-REF(OBV,5))<>SIGN(C-REF(C,5));
VPD_H:=(RET<0) AND (AMT>REF(AMT,5));
VPD_B:=(ABS(C-O)/REF(C,1)<MA(ABS(C-O)/REF(C,1),5)) AND (AMT>REF(AMT,5));

{=== 13. 换手率异常 TURN ===}
TURN1:=VOL/CAPITAL;
TURN_Z:=(TURN1-MA(TURN1,20))/STD(TURN1,20);
TURN_Q:=TURN1/HHV(TURN1,250)*0.9;
TURN_J:=TURN1/REF(TURN1,1)>2;
TURN_C:=TURN1>0.3;

{=== 14. 筹码松动 CHIP ===}
CHIP_A:=AMT/(FINANCE(1)+0.0001);
CHIP_CV:=STD(CHIP_A,10)/(MA(CHIP_A,10)+0.0001);
CHIP_R:=(FINANCE(1)-REF(FINANCE(1),20))/REF(FINANCE(1),20);
CHIP_F:=FINANCE(46)/CAPITAL - TURN1;

{=== 15. 日内强度 STR ===}
STR_C:=(C-L)/(H-L+0.0001);
STR_B:=ABS(C-O)/(H-L+0.0001);
STR_R:=(C-O)/(O+0.0001);
STR_V:=(C-SUM(C*AMT,1)/SUM(AMT,1))/C;

{=== 16. 波动率收缩 VOLC ===}
VOLC_A:=ATR10/HHV(ATR10,20);
VOLC_S:=STD(RET,5)/HHV(STD(RET,5),15);
VOLC_R:=(H-L)/C/HHV((H-L)/C,20);
VOLC_B:=(HHV(C,20)-LLV(C,20))/MA(C,20);

{=== 17. 相对强度 RES ===}
IDX5:="999999$CLOSE"/REF("999999$CLOSE",5)-1;
C5:=C/REF(C,5)-1;
RES_5:=C5-IDX5;
RES_B:=SLOPE(C,20);
RES_A:=MA(RET-RES_B*("999999$CLOSE"/REF("999999$CLOSE",1)-1),10);
RES_R:=C5;

{=== 18. 涨跌停 LIM ===}
LIM_U:=C>=ROUND(REF(C,1)*1.1*100)/100*0.998;
LIM_D:=C<=ROUND(REF(C,1)*0.9*100)/100*1.002;
LIM_C:=(H>=ROUND(REF(C,1)*1.1*100)/100*0.998) AND (C<ROUND(REF(C,1)*1.1*100)/100*0.998) AND (REF(C,1)<REF(ROUND(REF(C,1)*1.1*100)/100,1)*0.998);
LIM_O:=(ABS(O-C)/C<0.001) AND (C>=ROUND(REF(C,1)*1.1*100)/100*0.998);

{=== 19. 价格结构 PS ===}
PS_I:= (H<=REF(H,1)) AND (L>=REF(L,1));
PS_ID:=PS_I*SIGN(C-REF(C,1));
PS_G:=C-(HHV(C,3)+LLV(C,3))/2;
PS_F:=(H=HHV(H,5)) AND (C<O) AND ((HHV(C,5)-LLV(C,5))/MA(C,5)<0.05);

{=== 20. 成交量结构 VS ===}
VS_V:= 3*(SUM(C*AMT,20)/SUM(AMT,20)-MA(C,20))/(STD(C,20)+0.0001);
VS_C:=SUM((((C-L)-(H-C))/(H-L+0.0001))*AMT,20);
VS_P:=AMT/SUM(AMT,20);
VS_VP:=VS_V;

{=== 21. 非线性 NL ===}
NLH0:=SLOPE(C,15)/STD(C,15); {用斜率/标准差近似相关性}
NLL0:=ABS(C-REF(C,3))/STD(C,10);
NLQ0:=POW(MA(C,5)-MA(C,20),2)/(STD(C,20)*STD(C,20)+0.0001);
NLS0:=1/(1+EXP(-10*(C-MA(C,10))/STD(C,10)));

{=== 22. 微观噪声 MN ===}
MN_N:=IF(ABS(C-O)>0,MIN((H-L)/ABS(C-O)-1,50),50);
MN_V:=ABS(C-SUM(C*AMT,1)/SUM(AMT,1))/C;
MN_O:=ABS(O-REF(C,1))/(H-L+0.0001);
MN_C:=(C-O)/O-(C-SUM(C*AMT,1)/SUM(AMT,1))/C;

{=== 23. 博弈强弱 GT ===}
GT_U:=(H-MAX(O,C))/(H-L+0.0001);
GT_L:=(MIN(O,C)-L)/(H-L+0.0001);
GT_E:=SIGN(C-O)*ABS(C-O)/REF(C,1)/(ABS(REF(C-O,1))/REF(C,2)+0.0001)*(ABS(C-O)/REF(C,1)>1.5*ABS(REF(C-O,1))/REF(C,2));
GT_D:=ABS(C-O)/(H-L+0.0001)<0.1;

{=== 24. 流动性突变 LS ===}
LS_S:=(AMT-MA(AMT,20))/STD(AMT,20) - ((H-L)/C-MA((H-L)/C,20))/STD((H-L)/C,20);
LS_B:=(AMT/VOL-REF(AMT/VOL,1))/REF(AMT/VOL,1);
LS_I:=ILLIQ_A>MA(ILLIQ_A,20)+2*STD(ILLIQ_A,20);
LS_T:TURN1>MA(TURN1,20)+2*STD(TURN1,20);
